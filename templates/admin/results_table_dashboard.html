{% extends 'admin/base_site.html' %}
{% block extrastyle %}
<style>
    .content, .container, #content-main { max-width: 100% !important; width: 100% !important; margin: 0 !important; padding: 0 !important; }
    .breadcrumbs, .px-4 .container.mb-12, .flex.flex-wrap, .bg-white.border-b.border-base-200, .container.flex.items-center.h-16, #header-inner { display: none !important; }
    .px-4 { padding-left: 0 !important; padding-right: 0 !important; }
    .dashboard-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 10px 16px; 
        background: #f8f9fa; 
        border-bottom: 2px solid #dee2e6;
        position: sticky;
        top: 0;
        z-index: 20;
    }
    .dashboard-header h1 { margin: 0; font-size: 1.5rem; font-weight: 600; color: #333; }
    .dashboard-back { background: #007bff; color: #fff; padding: 8px 16px; border-radius: 4px; text-decoration: none; }

    .table-container { 
        padding: 12px; 
        height: calc(100vh - 120px);
        display: flex;
        flex-direction: column;
    }
    .table-wrapper {
        flex: 1;
        overflow: auto;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
    }
    table.uik-table { 
        width: 100%; 
        border-collapse: collapse; 
        font-size: 0.85rem;
        position: relative;
    }
    table.uik-table thead {
        position: sticky;
        top: 0;
        z-index: 10;
    }
    table.uik-table th { 
        background: #f1f5f9; 
        padding: 8px 6px; 
        border-bottom: 2px solid #e2e8f0; 
        text-align: center; 
        font-weight: 600; 
        color: #475569;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    table.uik-table td { padding: 8px 6px; border-bottom: 1px solid #e2e8f0; text-align: center; }
    tr.row-success { background: linear-gradient(90deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.05) 100%); }
    tr.row-warning { background: linear-gradient(90deg, rgba(245, 158, 11, 0.1) 0%, rgba(217, 119, 6, 0.05) 100%); }
    tr.row-danger-light { background: linear-gradient(90deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.05) 100%); }
    tr.row-yellow { background: linear-gradient(90deg, rgba(251, 191, 36, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%); border-left: 3px solid #f59e0b; }
    tr.row-agitator { background: rgba(59,130,246,.03); border-left: 3px solid #3b82f6; }
    tr.row-agitator td:first-child { padding-left: 20px; }
    tr.uik-separator { height: 8px; background: #f1f5f9; }
    tr.uik-separator td { border: none; padding: 0; }
    tfoot td { font-weight: 700; background: #fff7ed; }
    .badge { display:inline-block; padding:2px 6px; border-radius:6px; font-weight:600; font-size:.75rem; }
    .badge.success { background:#dcfce7; color:#166534; }
    .badge.warning { background:#fef3c7; color:#92400e; }
    .badge.danger { background:#fee2e2; color:#991b1b; }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞ */
    .filter-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s ease;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .filter-btn:hover {
        background: #0056b3;
    }
    
    .filter-btn.active {
        background: #28a745;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
    .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }
    
    .modal-content {
        background-color: #fff;
        margin: 5% auto;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #333;
        margin: 0;
    }
    
    .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
    }
    
    .close:hover {
        color: #000;
    }
    
    .filter-group {
        margin-bottom: 20px;
    }
    
    .filter-label {
        display: block;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        font-size: 0.9rem;
    }
    
    .filter-checkbox {
        margin-right: 8px;
        transform: scale(1.1);
    }
    
    .filter-checkbox-label {
        font-size: 0.9rem;
        color: #555;
        cursor: pointer;
        display: flex;
        align-items: center;
        margin-bottom: 6px;
    }
    
    .filter-checkbox-label:hover {
        color: #333;
    }
    
    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #dee2e6;
    }
    
    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    
    .btn-primary {
        background: #007bff;
        color: white;
    }
    
    .btn-primary:hover {
        background: #0056b3;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #545b62;
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-success:hover {
        background: #1e7e34;
    }
    
    /* –°–∫—Ä—ã—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ */
    .row-hidden {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header">
  <h1>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –£–ò–ö, –±—Ä–∏–≥–∞–¥–∏—Ä–∞–º –∏ –∞–≥–∏—Ç–∞—Ç–æ—Ä–∞–º</h1>
  <div style="display: flex; align-items: center; gap: 12px;">
    <button id="filterBtn" class="filter-btn" onclick="openFilterModal()">
      üîç –§–∏–ª—å—Ç—Ä
    </button>
    <a href="/admin/" class="dashboard-back">‚Üê –ù–∞–∑–∞–¥</a>
  </div>
  </div>
  <div class="table-container">
    <div class="table-wrapper">
      <table class="uik-table">
      <thead>
        <tr>
          <th>–£–ò–ö</th>
          <th>–ë—Ä–∏–≥–∞–¥–∏—Ä</th>
          <th>–ê–≥–∏—Ç–∞—Ç–æ—Ä(—ã)</th>
          <th>–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</th>
          <th>–û–±—â–∏–π –ø–ª–∞–Ω</th>
          <th>–û–±—â–∏–π —Ñ–∞–∫—Ç</th>
          <th>–û–±—â–∏–π %</th>
          <th>–ü–ª–∞–Ω 12.09</th>
          <th>–§–∞–∫—Ç 12.09</th>
          <th>%</th>
          <th>–ü–ª–∞–Ω 13.09</th>
          <th>–§–∞–∫—Ç 13.09</th>
          <th>%</th>
          <th>–ü–ª–∞–Ω 14.09</th>
          <th>–§–∞–∫—Ç 14.09</th>
          <th>%</th>
        </tr>
      </thead>
      <tbody>
        {% for r in uik_table_rows %}
        {% if r.row_type == 'separator' %}
        <tr class="uik-separator">
          <td colspan="16"></td>
        </tr>
        {% else %}
        <tr class="{% if r.row_type == 'total' %}row-{{ r.row_color }}{% else %}row-agitator{% endif %}">
          <td>
            {% if r.row_type == 'total' %}
              <strong>‚Ññ{{ r.uik_number }}</strong>
            {% else %}
              <span style="color: #6b7280; font-size: 0.8rem;">‚îî‚îÄ</span>
            {% endif %}
          </td>
          <td>
            {% if r.row_type == 'total' %}{{ r.brigadier }}{% endif %}
          </td>
          <td>
            {% if r.row_type == 'agitator' %}
              <span style="color: #2563eb; font-weight: 500;">{{ r.agitators }}</span>
            {% else %}
              <strong>{{ r.agitators }}</strong>
            {% endif %}
          </td>
          <td>
            {% if r.row_type == 'agitator' %}
              <span style="color: #059669; font-size: 0.85rem;">{{ r.managing_brigadier|default:"-" }}</span>
            {% else %}
              -
            {% endif %}
          </td>
          <td>
            {% if r.row_type == 'total' %}<strong>{{ r.plan_total }}</strong>{% else %}-{% endif %}
          </td>
          <td><strong>{{ r.fact_total }}</strong></td>
          <td>
            {% if r.row_type == 'total' %}
              <span class="badge {% if r.plan_execution_percent >= 100 %}success{% elif r.plan_execution_percent >= 80 %}warning{% else %}danger{% endif %}">{{ r.plan_execution_percent }}%</span>
            {% else %}
              -
            {% endif %}
          </td>
          <td>
            {% if r.row_type == 'total' %}{{ r.plan_12_sep }}{% else %}-{% endif %}
          </td>
          <td>{{ r.fact_12_sep }}</td>
          <td>
            {% if r.row_type == 'total' %}
              <span class="badge {% if r.plan_12_percent >= 100 %}success{% elif r.plan_12_percent >= 80 %}warning{% else %}danger{% endif %}">{{ r.plan_12_percent }}%</span>
            {% else %}
              -
            {% endif %}
          </td>
          <td>
            {% if r.row_type == 'total' %}{{ r.plan_13_sep }}{% else %}-{% endif %}
          </td>
          <td>{{ r.fact_13_sep }}</td>
          <td>
            {% if r.row_type == 'total' %}
              <span class="badge {% if r.plan_13_percent >= 100 %}success{% elif r.plan_13_percent >= 80 %}warning{% else %}danger{% endif %}">{{ r.plan_13_percent }}%</span>
            {% else %}
              -
            {% endif %}
          </td>
          <td>
            {% if r.row_type == 'total' %}{{ r.plan_14_sep }}{% else %}-{% endif %}
          </td>
          <td>{{ r.fact_14_sep }}</td>
          <td>
            {% if r.row_type == 'total' %}
              <span class="badge {% if r.plan_14_percent >= 100 %}success{% elif r.plan_14_percent >= 80 %}warning{% else %}danger{% endif %}">{{ r.plan_14_percent }}%</span>
            {% else %}
              -
            {% endif %}
          </td>
        </tr>
        {% endif %}
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <td colspan="4" style="text-align:right;">–ò—Ç–æ–≥–æ:</td>
          <td>{{ total_plan }}</td>
          <td>{{ total_fact }}</td>
          <td>
            <span class="badge {% if plan_execution_percent >= 100 %}success{% elif plan_execution_percent >= 80 %}warning{% else %}danger{% endif %}">{{ plan_execution_percent }}%</span>
          </td>
          <td>{{ total_plan_12_sep }}</td>
          <td>{{ total_12_sep }}</td>
          <td>
            <span class="badge {% if plan_12_percent >= 100 %}success{% elif plan_12_percent >= 80 %}warning{% else %}danger{% endif %}">{{ plan_12_percent }}%</span>
          </td>
          <td>{{ total_plan_13_sep }}</td>
          <td>{{ total_13_sep }}</td>
          <td>
            <span class="badge {% if plan_13_percent >= 100 %}success{% elif plan_13_percent >= 80 %}warning{% else %}danger{% endif %}">{{ plan_13_percent }}%</span>
          </td>
          <td>{{ total_plan_14_sep }}</td>
          <td>{{ total_14_sep }}</td>
          <td>
            <span class="badge {% if plan_14_percent >= 100 %}success{% elif plan_14_percent >= 80 %}warning{% else %}danger{% endif %}">{{ plan_14_percent }}%</span>
          </td>
        </tr>
      </tfoot>
      </table>
    </div>
  </div>

<div style="text-align: center; padding: 10px; color: #64748b; font-size: 0.75rem;">
    –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫
</div>

<script>
// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
function saveScrollPosition() {
    const tableWrapper = document.querySelector('.table-wrapper');
    if (tableWrapper) {
        localStorage.setItem('tableScrollPosition', tableWrapper.scrollTop);
    }
}

// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
function restoreScrollPosition() {
    const savedPosition = localStorage.getItem('tableScrollPosition');
    if (savedPosition) {
        const tableWrapper = document.querySelector('.table-wrapper');
        if (tableWrapper) {
            // –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
            setTimeout(function() {
                tableWrapper.scrollTop = parseInt(savedPosition);
                localStorage.removeItem('tableScrollPosition');
            }, 100);
        }
    }
}

// –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ —Ç–∞–±–ª–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    const tableWrapper = document.querySelector('.table-wrapper');
    if (tableWrapper) {
        tableWrapper.addEventListener('scroll', saveScrollPosition);
    }
});

// –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', restoreScrollPosition);

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
window.addEventListener('load', function() {
    setTimeout(restoreScrollPosition, 200);
});

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
setTimeout(function() {
    saveScrollPosition(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
    window.location.reload();
}, 30000);

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
function openFilterModal() {
    document.getElementById('filterModal').style.display = 'block';
    loadFiltersFromStorage();
}

function closeFilterModal() {
    document.getElementById('filterModal').style.display = 'none';
}

function applyFilters() {
    const filters = {
        includeDmitriev: document.getElementById('includeDmitriev').checked,
        includeGutorova: document.getElementById('includeGutorova').checked,
        includeOthers: document.getElementById('includeOthers').checked
    };
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –≤ localStorage
    localStorage.setItem('tableDashboardFilters', JSON.stringify(filters));
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –∫ —Ç–∞–±–ª–∏—Ü–µ
    applyTableFilters(filters);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Ñ–∏–ª—å—Ç—Ä–∞
    updateFilterButton();
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    document.getElementById('filterModal').style.display = 'none';
}

function clearFilters() {
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–≤—Å–µ –≤–∫–ª—é—á–µ–Ω—ã)
    document.getElementById('includeDmitriev').checked = true;
    document.getElementById('includeGutorova').checked = true;
    document.getElementById('includeOthers').checked = true;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ localStorage
    const defaultFilters = {
        includeDmitriev: true,
        includeGutorova: true,
        includeOthers: true
    };
    localStorage.setItem('tableDashboardFilters', JSON.stringify(defaultFilters));
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –∫ —Ç–∞–±–ª–∏—Ü–µ
    applyTableFilters(defaultFilters);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Ñ–∏–ª—å—Ç—Ä–∞
    updateFilterButton();
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    document.getElementById('filterModal').style.display = 'none';
}

function loadFiltersFromStorage() {
    const savedFilters = localStorage.getItem('tableDashboardFilters');
    if (savedFilters) {
        const filters = JSON.parse(savedFilters);
        
        document.getElementById('includeDmitriev').checked = filters.includeDmitriev !== false;
        document.getElementById('includeGutorova').checked = filters.includeGutorova !== false;
        document.getElementById('includeOthers').checked = filters.includeOthers !== false;
    } else {
        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—Å–µ –≤–∫–ª—é—á–µ–Ω—ã
        document.getElementById('includeDmitriev').checked = true;
        document.getElementById('includeGutorova').checked = true;
        document.getElementById('includeOthers').checked = true;
    }
}

function updateFilterButton() {
    const savedFilters = localStorage.getItem('tableDashboardFilters');
    const filterBtn = document.getElementById('filterBtn');
    
    if (savedFilters) {
        const filters = JSON.parse(savedFilters);
        // –§–∏–ª—å—Ç—Ä –∞–∫—Ç–∏–≤–µ–Ω –µ—Å–ª–∏ –Ω–µ –≤—Å–µ –≥—Ä—É–ø–ø—ã –≤–∫–ª—é—á–µ–Ω—ã
        const hasActiveFilters = !filters.includeDmitriev || !filters.includeGutorova || !filters.includeOthers;
        
        if (hasActiveFilters) {
            filterBtn.classList.add('active');
            filterBtn.innerHTML = 'üîç –§–∏–ª—å—Ç—Ä (–∞–∫—Ç–∏–≤–µ–Ω)';
        } else {
            filterBtn.classList.remove('active');
            filterBtn.innerHTML = 'üîç –§–∏–ª—å—Ç—Ä';
        }
    } else {
        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ñ–∏–ª—å—Ç—Ä—ã –Ω–µ –∞–∫—Ç–∏–≤–Ω—ã (–≤—Å–µ –≤–∫–ª—é—á–µ–Ω—ã)
        filterBtn.classList.remove('active');
        filterBtn.innerHTML = 'üîç –§–∏–ª—å—Ç—Ä';
    }
}

function applyTableFilters(filters) {
    console.log('–ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã:', filters);
    const table = document.querySelector('.uik-table');
    const rows = table.querySelectorAll('tbody tr');
    
    // –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏
    rows.forEach(row => {
        row.classList.remove('row-hidden');
    });
    
    let hiddenCount = 0;
    
    // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –∞–≥–∏—Ç–∞—Ç–æ—Ä–æ–≤ —Å –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–º–∏ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è–º–∏
    if (!filters.includeDmitriev || !filters.includeGutorova || !filters.includeOthers) {
        rows.forEach(row => {
            if (row.classList.contains('row-agitator')) {
                const leaderCell = row.cells[3]; // –ö–æ–ª–æ–Ω–∫–∞ "–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å"
                const leaderText = leaderCell.textContent.trim();
                
                let shouldHide = false;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –î–º–∏—Ç—Ä–∏–µ–≤–∞ –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–º–∏–ª–∏–∏
                if (!filters.includeDmitriev) {
                    const dmitrievSurnames = ['–î–º–∏—Ç—Ä–∏–µ–≤', '–ë–µ—Ä—É–∞—à–≤–∏–ª–∏', '–ì–æ—Ä—é–Ω–æ–≤–∞', '–ì—É–ª–∏—á–µ–≤–∞', '–ö–æ—Å–∏–Ω–æ–≤–∞', '–ú–∞—Å–ª–µ–Ω–Ω–∏–∫–æ–≤–∞', '–ü–∞—Ö–æ–º–æ–≤–∞', '–°–∏—Ç–Ω–∏–∫–æ–≤–∞', '–°–æ–ª–æ–¥–æ–≤–Ω–∏–∫–æ–≤–∞'];
                    if (dmitrievSurnames.some(surname => leaderText.includes(surname))) {
                        shouldHide = true;
                        console.log('–°–∫—Ä—ã–≤–∞–µ–º –∞–≥–∏—Ç–∞—Ç–æ—Ä–∞ —Å —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–º:', leaderText, '(–î–º–∏—Ç—Ä–∏–µ–≤)');
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ì—É—Ç–æ—Ä–æ–≤—É
                if (!filters.includeGutorova && leaderText.includes('–ì—É—Ç–æ—Ä–æ–≤–∞')) {
                    shouldHide = true;
                    console.log('–°–∫—Ä—ã–≤–∞–µ–º –∞–≥–∏—Ç–∞—Ç–æ—Ä–∞ —Å —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–º:', leaderText, '(–ì—É—Ç–æ—Ä–æ–≤–∞)');
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—á–∏—Ö (—Ç–µ—Ö, –∫—Ç–æ –Ω–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –î–º–∏—Ç—Ä–∏–µ–≤—É –∏ –ì—É—Ç–æ—Ä–æ–≤–æ–π)
                if (!filters.includeOthers) {
                    const dmitrievSurnames = ['–î–º–∏—Ç—Ä–∏–µ–≤', '–ë–µ—Ä—É–∞—à–≤–∏–ª–∏', '–ì–æ—Ä—é–Ω–æ–≤–∞', '–ì—É–ª–∏—á–µ–≤–∞', '–ö–æ—Å–∏–Ω–æ–≤–∞', '–ú–∞—Å–ª–µ–Ω–Ω–∏–∫–æ–≤–∞', '–ü–∞—Ö–æ–º–æ–≤–∞', '–°–∏—Ç–Ω–∏–∫–æ–≤–∞', '–°–æ–ª–æ–¥–æ–≤–Ω–∏–∫–æ–≤–∞'];
                    const isDmitriev = dmitrievSurnames.some(surname => leaderText.includes(surname));
                    const isGutorova = leaderText.includes('–ì—É—Ç–æ—Ä–æ–≤–∞');
                    
                    if (!isDmitriev && !isGutorova) {
                        shouldHide = true;
                        console.log('–°–∫—Ä—ã–≤–∞–µ–º –∞–≥–∏—Ç–∞—Ç–æ—Ä–∞ —Å —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–º:', leaderText, '(–ü—Ä–æ—á–∏–µ)');
                    }
                }
                
                if (shouldHide) {
                    row.classList.add('row-hidden');
                    hiddenCount++;
                }
            }
        });
    }
    
    console.log('–°–∫—Ä—ã—Ç–æ —Å—Ç—Ä–æ–∫:', hiddenCount);
    
    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–∏
    console.log('–ù–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–µ—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤...');
    recalculateTotals();
}

function recalculateTotals() {
    console.log('–ù–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–µ—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤...');
    const table = document.querySelector('.uik-table');
    const rows = table.querySelectorAll('tbody tr');
    
    // –°–Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É "–ò—Ç–æ–≥–æ –ø–æ –£–ò–ö"
    rows.forEach((row, index) => {
        if (row.classList.contains('row-success') || row.classList.contains('row-warning') || 
            row.classList.contains('row-danger-light') || row.classList.contains('row-yellow')) {
            
            console.log(`–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É ${index + 1} (–£–ò–ö)`);
            
            // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∞–≥–∏—Ç–∞—Ç–æ—Ä—ã —ç—Ç–æ–≥–æ –£–ò–ö (—Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –£–ò–ö –∏–ª–∏ –∫–æ–Ω—Ü–∞)
            let currentRow = row.nextElementSibling;
            let agitatorFactTotal = 0;
            let agitatorFact12 = 0;
            let agitatorFact13 = 0;
            let agitatorFact14 = 0;
            
            let agitatorCount = 0;
            while (currentRow && currentRow.classList.contains('row-agitator')) {
                // –°—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ —Å—Ç—Ä–æ–∫–∏ –∞–≥–∏—Ç–∞—Ç–æ—Ä–æ–≤
                if (!currentRow.classList.contains('row-hidden')) {
                    const factTotal = parseInt(currentRow.cells[5].textContent) || 0; // –û–±—â–∏–π —Ñ–∞–∫—Ç
                    const fact12 = parseInt(currentRow.cells[8].textContent) || 0; // –§–∞–∫—Ç 12.09
                    const fact13 = parseInt(currentRow.cells[11].textContent) || 0; // –§–∞–∫—Ç 13.09
                    const fact14 = parseInt(currentRow.cells[14].textContent) || 0; // –§–∞–∫—Ç 14.09
                    
                    agitatorFactTotal += factTotal; // –û–±—â–∏–π —Ñ–∞–∫—Ç
                    agitatorFact12 += fact12; // –§–∞–∫—Ç 12.09
                    agitatorFact13 += fact13; // –§–∞–∫—Ç 13.09
                    agitatorFact14 += fact14; // –§–∞–∫—Ç 14.09
                    
                    agitatorCount++;
                    console.log(`  –ê–≥–∏—Ç–∞—Ç–æ—Ä ${agitatorCount}: –æ–±—â–∏–π=${factTotal}, 12=${fact12}, 13=${fact13}, 14=${fact14}`);
                } else {
                    console.log(`  –ê–≥–∏—Ç–∞—Ç–æ—Ä —Å–∫—Ä—ã—Ç`);
                }
                currentRow = currentRow.nextElementSibling;
            }
            
            console.log(`  –ò—Ç–æ–≥–æ –∞–≥–∏—Ç–∞—Ç–æ—Ä–æ–≤: ${agitatorCount}, –æ–±—â–∏–π —Ñ–∞–∫—Ç: ${agitatorFactTotal}`);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Å—Ç—Ä–æ–∫–µ "–ò—Ç–æ–≥–æ –ø–æ –£–ò–ö"
            const oldTotal = row.cells[5].textContent;
            row.cells[5].textContent = agitatorFactTotal; // –û–±—â–∏–π —Ñ–∞–∫—Ç
            console.log(`  –û–±–Ω–æ–≤–ª–µ–Ω –æ–±—â–∏–π —Ñ–∞–∫—Ç: ${oldTotal} ‚Üí ${agitatorFactTotal}`);
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã
            const planTotal = parseInt(row.cells[4].textContent) || 0; // –û–±—â–∏–π –ø–ª–∞–Ω
            const totalPercent = planTotal > 0 ? Math.round((agitatorFactTotal / planTotal) * 100 * 10) / 10 : 0;
            row.cells[6].innerHTML = `<span class="badge ${totalPercent >= 100 ? 'success' : totalPercent >= 80 ? 'warning' : 'danger'}">${totalPercent}%</span>`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∞–∫—Ç—ã –ø–æ –¥–Ω—è–º
            row.cells[8].textContent = agitatorFact12; // –§–∞–∫—Ç 12.09
            row.cells[11].textContent = agitatorFact13; // –§–∞–∫—Ç 13.09
            row.cells[14].textContent = agitatorFact14; // –§–∞–∫—Ç 14.09
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã –ø–æ –¥–Ω—è–º
            const plan12 = parseInt(row.cells[7].textContent) || 0; // –ü–ª–∞–Ω 12.09
            const percent12 = plan12 > 0 ? Math.round((agitatorFact12 / plan12) * 100 * 10) / 10 : 0;
            row.cells[9].innerHTML = `<span class="badge ${percent12 >= 100 ? 'success' : percent12 >= 80 ? 'warning' : 'danger'}">${percent12}%</span>`;
            
            const plan13 = parseInt(row.cells[10].textContent) || 0; // –ü–ª–∞–Ω 13.09
            const percent13 = plan13 > 0 ? Math.round((agitatorFact13 / plan13) * 100 * 10) / 10 : 0;
            row.cells[12].innerHTML = `<span class="badge ${percent13 >= 100 ? 'success' : percent13 >= 80 ? 'warning' : 'danger'}">${percent13}%</span>`;
            
            const plan14 = parseInt(row.cells[13].textContent) || 0; // –ü–ª–∞–Ω 14.09
            const percent14 = plan14 > 0 ? Math.round((agitatorFact14 / plan14) * 100 * 10) / 10 : 0;
            row.cells[15].innerHTML = `<span class="badge ${percent14 >= 100 ? 'success' : percent14 >= 80 ? 'warning' : 'danger'}">${percent14}%</span>`;
        }
    });
    
    // –¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–∏–µ –∏—Ç–æ–≥–∏ –≤ —Ñ—É—Ç–µ—Ä–µ
    // –°—É–º–º–∏—Ä—É–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ "–ò—Ç–æ–≥–æ –ø–æ –£–ò–ö" (–æ–Ω–∏ —É–∂–µ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω—ã –≤—ã—à–µ)
    let totalPlan = 0, totalFact = 0;
    let totalPlan12 = 0, totalFact12 = 0;
    let totalPlan13 = 0, totalFact13 = 0;
    let totalPlan14 = 0, totalFact14 = 0;
    
    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–æ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫ "–ò—Ç–æ–≥–æ –ø–æ –£–ò–ö" (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∞–≥–∏—Ç–∞—Ç–æ—Ä–æ–≤)
    rows.forEach(row => {
        if (row.classList.contains('row-success') || row.classList.contains('row-warning') || 
            row.classList.contains('row-danger-light') || row.classList.contains('row-yellow')) {
            
            totalPlan += parseInt(row.cells[4].textContent) || 0; // –û–±—â–∏–π –ø–ª–∞–Ω
            totalFact += parseInt(row.cells[5].textContent) || 0; // –û–±—â–∏–π —Ñ–∞–∫—Ç (—É–∂–µ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω)
            totalPlan12 += parseInt(row.cells[7].textContent) || 0; // –ü–ª–∞–Ω 12.09
            totalFact12 += parseInt(row.cells[8].textContent) || 0; // –§–∞–∫—Ç 12.09 (—É–∂–µ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω)
            totalPlan13 += parseInt(row.cells[10].textContent) || 0; // –ü–ª–∞–Ω 13.09
            totalFact13 += parseInt(row.cells[11].textContent) || 0; // –§–∞–∫—Ç 13.09 (—É–∂–µ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω)
            totalPlan14 += parseInt(row.cells[13].textContent) || 0; // –ü–ª–∞–Ω 14.09
            totalFact14 += parseInt(row.cells[14].textContent) || 0; // –§–∞–∫—Ç 14.09 (—É–∂–µ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω)
        }
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–∏ –≤ —Ñ—É—Ç–µ—Ä–µ —Ç–∞–±–ª–∏—Ü—ã
    const footer = table.querySelector('tfoot tr');
    console.log('–§—É—Ç–µ—Ä –Ω–∞–π–¥–µ–Ω:', !!footer);
    if (footer) {
        console.log('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–æ–ª–±—Ü–æ–≤ –≤ —Ñ—É—Ç–µ—Ä–µ:', footer.cells.length);
        
        // –í—ã–≤–æ–¥–∏–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤—Å–µ—Ö —Å—Ç–æ–ª–±—Ü–æ–≤ —Ñ—É—Ç–µ—Ä–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        for (let i = 0; i < footer.cells.length; i++) {
            console.log(`  –°—Ç–æ–ª–±–µ—Ü ${i}:`, footer.cells[i].textContent.trim());
        }
        
        console.log('–û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É—Ç–µ—Ä:');
        console.log('  totalPlan:', totalPlan);
        console.log('  totalFact:', totalFact);
        console.log('  totalPlan12:', totalPlan12);
        console.log('  totalFact12:', totalFact12);
        console.log('  totalPlan13:', totalPlan13);
        console.log('  totalFact13:', totalFact13);
        console.log('  totalPlan14:', totalPlan14);
        console.log('  totalFact14:', totalFact14);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–æ–≤ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
        if (footer.cells[1]) {
            footer.cells[1].textContent = totalPlan; // –û–±—â–∏–π –ø–ª–∞–Ω
            console.log('  –û–±–Ω–æ–≤–ª–µ–Ω —Å—Ç–æ–ª–±–µ—Ü 1 (–û–±—â–∏–π –ø–ª–∞–Ω):', totalPlan);
        }
        
        if (footer.cells[2]) {
            footer.cells[2].textContent = totalFact; // –û–±—â–∏–π —Ñ–∞–∫—Ç
            console.log('  –û–±–Ω–æ–≤–ª–µ–Ω —Å—Ç–æ–ª–±–µ—Ü 2 (–û–±—â–∏–π —Ñ–∞–∫—Ç):', totalFact);
        }
        
        // –û–±—â–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç
        if (footer.cells[3]) {
            const totalPercent = totalPlan > 0 ? Math.round((totalFact / totalPlan) * 100 * 10) / 10 : 0;
            footer.cells[3].innerHTML = `<span class="badge ${totalPercent >= 100 ? 'success' : totalPercent >= 80 ? 'warning' : 'danger'}">${totalPercent}%</span>`;
        }
        
        if (footer.cells[4]) {
            footer.cells[4].textContent = totalPlan12; // –ü–ª–∞–Ω 12.09
            console.log('  –û–±–Ω–æ–≤–ª–µ–Ω —Å—Ç–æ–ª–±–µ—Ü 4 (–ü–ª–∞–Ω 12.09):', totalPlan12);
        }
        
        if (footer.cells[5]) {
            footer.cells[5].textContent = totalFact12; // –§–∞–∫—Ç 12.09
            console.log('  –û–±–Ω–æ–≤–ª–µ–Ω —Å—Ç–æ–ª–±–µ—Ü 5 (–§–∞–∫—Ç 12.09):', totalFact12);
        }
        
        // –ü—Ä–æ—Ü–µ–Ω—Ç 12.09
        if (footer.cells[6]) {
            const percent12 = totalPlan12 > 0 ? Math.round((totalFact12 / totalPlan12) * 100 * 10) / 10 : 0;
            footer.cells[6].innerHTML = `<span class="badge ${percent12 >= 100 ? 'success' : percent12 >= 80 ? 'warning' : 'danger'}">${percent12}%</span>`;
        }
        
        if (footer.cells[7]) {
            footer.cells[7].textContent = totalPlan13; // –ü–ª–∞–Ω 13.09
        }
        
        if (footer.cells[8]) {
            footer.cells[8].textContent = totalFact13; // –§–∞–∫—Ç 13.09
        }
        
        // –ü—Ä–æ—Ü–µ–Ω—Ç 13.09
        if (footer.cells[9]) {
            const percent13 = totalPlan13 > 0 ? Math.round((totalFact13 / totalPlan13) * 100 * 10) / 10 : 0;
            footer.cells[9].innerHTML = `<span class="badge ${percent13 >= 100 ? 'success' : percent13 >= 80 ? 'warning' : 'danger'}">${percent13}%</span>`;
        }
        
        if (footer.cells[10]) {
            footer.cells[10].textContent = totalPlan14; // –ü–ª–∞–Ω 14.09
        }
        
        if (footer.cells[11]) {
            footer.cells[11].textContent = totalFact14; // –§–∞–∫—Ç 14.09
        }
        
        // –ü—Ä–æ—Ü–µ–Ω—Ç 14.09
        if (footer.cells[12]) {
            const percent14 = totalPlan14 > 0 ? Math.round((totalFact14 / totalPlan14) * 100 * 10) / 10 : 0;
            footer.cells[12].innerHTML = `<span class="badge ${percent14 >= 100 ? 'success' : percent14 >= 80 ? 'warning' : 'danger'}">${percent14}%</span>`;
        }
        
        console.log('–§—É—Ç–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ');
    } else {
        console.log('–û–®–ò–ë–ö–ê: –§—É—Ç–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω!');
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
window.onclick = function(event) {
    const modal = document.getElementById('filterModal');
    if (event.target == modal) {
        closeFilterModal();
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –∏–∑ localStorage
    const savedFilters = localStorage.getItem('tableDashboardFilters');
    if (savedFilters) {
        const filters = JSON.parse(savedFilters);
        applyTableFilters(filters);
    }
    
    updateFilterButton();
});
</script>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
<div id="filterModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">–§–∏–ª—å—Ç—Ä—ã —Ç–∞–±–ª–∏—Ü—ã</h2>
            <span class="close" onclick="closeFilterModal()">&times;</span>
        </div>
        
        <div class="filter-group">
            <label class="filter-label">–ü–æ–∫–∞–∑–∞—Ç—å –∞–≥–∏—Ç–∞—Ç–æ—Ä–æ–≤ —Å —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è–º–∏:</label>
            <label class="filter-checkbox-label">
                <input type="checkbox" id="includeDmitriev" class="filter-checkbox">
                –î–º–∏—Ç—Ä–∏–µ–≤ –ê.–ê. –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ
            </label>
            <label class="filter-checkbox-label">
                <input type="checkbox" id="includeGutorova" class="filter-checkbox">
                –ì—É—Ç–æ—Ä–æ–≤–∞ –ï.–í.
            </label>
            <label class="filter-checkbox-label">
                <input type="checkbox" id="includeOthers" class="filter-checkbox">
                –ü—Ä–æ—á–∏–µ
            </label>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeFilterModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" onclick="clearFilters()">–û—á–∏—Å—Ç–∏—Ç—å</button>
            <button class="btn btn-success" onclick="applyFilters()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

{% endblock %}


